<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impact Face Particles</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; }
        canvas { display: block; }
        #loading {
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            color: white; font-family: sans-serif; pointer-events: none;
            text-align: center;
        }
        #guide {
            position: absolute; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            color: #888; font-family: sans-serif; font-size: 14px;
            pointer-events: none;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="loading">두상 데이터를 불러오는 중...</div>
    <div id="guide">마우스를 움직여 회전하고, <b>화면을 클릭</b>해보세요!</div>
    
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // 1. 장면 설정
        const scene = new THREE.Scene();
        // 약간의 안개 효과를 주어 깊이감을 더함
        scene.fog = new THREE.FogExp2(0x050505, 0.05);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // 2. 정육면체 (Cube) - 배경 장식용
        const cubeGeometry = new THREE.BoxGeometry(10, 10, 10);
        const cubeMaterial = new THREE.MeshBasicMaterial({ 
            color: 0x222222, 
            wireframe: true, 
            transparent: true, 
            opacity: 0.2 
        });
        const cube = new THREE.Mesh(cubeGeometry, cubeMaterial);
        scene.add(cube);

        // 3. 변수 선언
        let faceParticles; 
        let originalPositions; // 입자들의 원래 얼굴 위치 저장
        let randomPositions;   // 흩어졌을 때의 랜덤 위치 저장
        let isExploded = false; // 현재 흩어진 상태인지 확인

        const loader = new GLTFLoader();

        // 4. 모델 로드 및 설정
        loader.load(
            './face.glb', 
            function (gltf) {
                const model = gltf.scene;
                let targetGeometry = null;

                model.traverse((child) => {
                    if (child.isMesh && targetGeometry === null) {
                        targetGeometry = child.geometry;
                    }
                });

                if (targetGeometry) {
                    targetGeometry.center();
                    
                    const count = targetGeometry.attributes.position.count;
                    originalPositions = new Float32Array(count * 3);
                    randomPositions = new Float32Array(count * 3);
                    
                    // 원래 위치와 랜덤 위치(폭발용) 데이터 생성
                    const posArray = targetGeometry.attributes.position.array;
                    for(let i = 0; i < count; i++) {
                        // 원래 얼굴 좌표 복사
                        originalPositions[i*3] = posArray[i*3];
                        originalPositions[i*3+1] = posArray[i*3+1];
                        originalPositions[i*3+2] = posArray[i*3+2];

                        // 폭발했을 때 갈 랜덤 좌표 생성 (범위를 넓게 잡음)
                        randomPositions[i*3] = (Math.random() - 0.5) * 10; // X
                        randomPositions[i*3+1] = (Math.random() - 0.5) * 10; // Y
                        randomPositions[i*3+2] = (Math.random() - 0.5) * 10; // Z
                    }

                    // 재질 설정 (더 빛나고 예쁘게)
                    const particlesMaterial = new THREE.PointsMaterial({
                        color: 0x00ffff, 
                        size: 0.03,      
                        sizeAttenuation: true,
                        transparent: true,
                        opacity: 0.8,
                        blending: THREE.AdditiveBlending // 빛이 겹치면 더 밝아지게
                    });

                    faceParticles = new THREE.Points(targetGeometry, particlesMaterial);
                    
                    // ★★★ 크기 조정 (여기서 4배 키움: 1.5 -> 6.0) ★★★
                    faceParticles.scale.set(6.0, 6.0, 6.0); 
                    
                    scene.add(faceParticles);
                    
                    document.getElementById('loading').style.display = 'none';
                }
            },
            undefined,
            function (error) { console.error(error); }
        );

        camera.position.z = 8;

        // 5. 마우스 및 클릭 이벤트
        let mouseX = 0; 
        let mouseY = 0;
        let targetRotateX = 0; 
        let targetRotateY = 0;

        const windowHalfX = window.innerWidth / 2;